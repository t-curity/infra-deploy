name: Deploy Services

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - ai
          - sdk
          - demo
          - landing
          - nginx
          - monitoring
      environment:
        description: 'Target environment'
        required: true
        default: 'kakao-prod'
        type: choice
        options:
          - aws-test
          - kakao-prod
  repository_dispatch:
    types: [deploy-backend, deploy-ai, deploy-sdk, deploy-demo, deploy-landing, deploy-all]

env:
  REGISTRY: ghcr.io
  ORG: t-curity

jobs:
  # ============================================================
  # í™˜ê²½ ì„¤ì •
  # ============================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      main_host: ${{ steps.env.outputs.main_host }}
      gpu_host: ${{ steps.env.outputs.gpu_host }}
      gpu_private: ${{ steps.env.outputs.gpu_private }}
      service: ${{ steps.svc.outputs.service }}
    steps:
      - name: Set environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'kakao-prod' }}"
          if [ "$ENV" = "kakao-prod" ]; then
            # ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ í”„ë¡œë•ì…˜
            echo "main_host=61.109.236.16" >> $GITHUB_OUTPUT
            echo "gpu_host=61.109.238.4" >> $GITHUB_OUTPUT
            echo "gpu_private=10.0.83.48" >> $GITHUB_OUTPUT
          else
            # AWS í…ŒìŠ¤íŠ¸ (ê¸°ë³¸ê°’)
            echo "main_host=3.36.60.13" >> $GITHUB_OUTPUT
            echo "gpu_host=54.180.253.215" >> $GITHUB_OUTPUT
            echo "gpu_private=10.0.83.190" >> $GITHUB_OUTPUT
          fi

      - name: Set service
        id: svc
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            case "${{ github.event.action }}" in
              deploy-backend) echo "service=backend" >> $GITHUB_OUTPUT ;;
              deploy-ai) echo "service=ai" >> $GITHUB_OUTPUT ;;
              deploy-sdk) echo "service=sdk" >> $GITHUB_OUTPUT ;;
              deploy-demo) echo "service=demo" >> $GITHUB_OUTPUT ;;
              deploy-landing) echo "service=landing" >> $GITHUB_OUTPUT ;;
              *) echo "service=all" >> $GITHUB_OUTPUT ;;
            esac
          else
            echo "service=${{ github.event.inputs.service || 'all' }}" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # Backend ë°°í¬ (Main Server)
  # ============================================================
  deploy-backend:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'backend'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /home/ubuntu/tcurity-project/tcurity-backend/data
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/backend:develop
            docker stop tcurity-backend 2>/dev/null || true
            docker rm tcurity-backend 2>/dev/null || true
            
            docker run -d \
              --name tcurity-backend \
              --restart unless-stopped \
              -p 8000:8000 \
              -v /home/ubuntu/tcurity-project/tcurity-backend/data:/app/data \
              -e AI_SERVER_URL=http://${{ needs.setup.outputs.gpu_private }}:9000 \
              -e TCURITY_API_URL=http://localhost:8000 \
              -e CLIENT_SECRET_KEY=demo-secret-key-123 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/backend:develop
            
            docker image prune -f
            echo "âœ… Backend deployed"

  # ============================================================
  # AI Server ë°°í¬ (GPU Server)
  # ============================================================
  deploy-ai:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'ai'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy AI Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'kakao-prod' }}
        with:
          host: ${{ needs.setup.outputs.gpu_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DEPLOY_ENV
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/ai:develop
            docker stop tcurity-ai 2>/dev/null || true
            docker rm tcurity-ai 2>/dev/null || true
            
            # GPU ì˜µì…˜: ì¹´ì¹´ì˜¤ëŠ” GPU ì‚¬ìš©, AWSëŠ” CPUë§Œ
            if [ "$DEPLOY_ENV" = "kakao-prod" ]; then
              GPU_OPT="--gpus all"
              MLFLOW_URI="http://61.109.238.4:5000"
            else
              GPU_OPT=""
              MLFLOW_URI="http://54.180.253.215:5000"
            fi
            
            docker run -d \
              --name tcurity-ai \
              --restart unless-stopped \
              $GPU_OPT \
              -p 9000:9000 \
              -v /home/ubuntu/tcurity-ai/models:/models:ro \
              -v /home/ubuntu/tcurity-ai/data:/data:ro \
              -v /home/ubuntu/tcurity-ai/data/drag_trainset:/data/drag_trainset:rw \
              -v /home/ubuntu/tcurity-ai/data/phase_b:/data/phase_b:rw \
              -e PROJECT_ROOT=/app \
              \
              `# ===== MLflow ì„¤ì • =====` \
              -e MLFLOW_TRACKING_URI=$MLFLOW_URI \
              -e MLFLOW_EXPERIMENT_NAME=captcha-effnet-tracking \
              \
              `# ===== Phase A: Isolation Forest =====` \
              -e PHASE_A_EXPERIMENT_NAME=phase-a-isolation-forest \
              -e PHASE_A_SAVE_ENABLED=1 \
              -e PHASE_A_SAVE_RATIO=1.0 \
              -e PHASE_A_DATA_DIR=/data/drag_trainset \
              -e PHASE_A_MODEL_DIR=/models/phase_a \
              -e PHASE_A_DATASET_VERSION=v001 \
              -e SAVE_DIAGNOSTICS=0 \
              -e KEEP_BACKUPS=2 \
              \
              `# ===== Phase B: Behavior (Random Forest) =====` \
              -e PHASE_B_BEHAVIOR_EXPERIMENT_NAME=phase-b-random-forest \
              -e PHASE_B_BEHAVIOR_DATASET_VERSION=v001 \
              \
              `# ===== Phase B: Image (EfficientNet) =====` \
              -e PHASE_B_IMAGE_EXPERIMENT_NAME=phase-b-efficientnet \
              -e PHASE_B_SAVE_ENABLED=1 \
              -e PHASE_B_SAVE_RATIO=1.0 \
              -e PHASE_B_DATA_DIR=/data/phase_b \
              -e IMAGE_DATA_ROOT=/data/images \
              -e MODEL_OUTPUT_ROOT=/app/models \
              -e PHASE_B_PROBLEM_IMAGE_ROOT=/data/processed_images \
              -e MODEL_A_DIR=/models/phase_a \
              -e MODEL_B_DIR=/models/phase_b \
              \
              ${{ env.REGISTRY }}/${{ env.ORG }}/ai:develop
            
            docker image prune -f
            echo "âœ… AI Server deployed with MLflow + Phase A/B configs"

  # ============================================================
  # SDK ë°°í¬ (Main Server)
  # ============================================================
  deploy-sdk:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'sdk'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy SDK
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/sdk:dev
            docker stop tcurity-sdk 2>/dev/null || true
            docker rm tcurity-sdk 2>/dev/null || true
            
            docker run -d \
              --name tcurity-sdk \
              --restart unless-stopped \
              -p 3000:80 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/sdk:dev
            
            docker image prune -f
            echo "âœ… SDK deployed"

  # ============================================================
  # Demo Site ë°°í¬ (Main Server)
  # ============================================================
  deploy-demo:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'demo'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Demo Site
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/demo:dev
            docker stop tcurity-demo 2>/dev/null || true
            docker rm tcurity-demo 2>/dev/null || true
            
            docker run -d \
              --name tcurity-demo \
              --restart unless-stopped \
              -p 5173:80 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/demo:dev
            
            docker image prune -f
            echo "âœ… Demo Site deployed"

  # ============================================================
  # Landing Page ë°°í¬ (Main Server)
  # ============================================================
  deploy-landing:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'landing'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Landing Page
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/landing:dev
            docker stop tcurity-landing 2>/dev/null || true
            docker rm tcurity-landing 2>/dev/null || true
            
            docker run -d \
              --name tcurity-landing \
              --restart unless-stopped \
              -p 4000:80 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/landing:dev
            
            docker image prune -f
            echo "âœ… Landing Page deployed"

  # ============================================================
  # Monitoring ë°°í¬ (Main + GPU Server)
  # ============================================================
  deploy-monitoring:
    needs: setup
    if: needs.setup.outputs.service == 'monitoring'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Monitoring on GPU Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.gpu_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # node-exporter ë°°í¬
            docker stop node-exporter 2>/dev/null || true
            docker rm node-exporter 2>/dev/null || true
            
            docker run -d \
              --name node-exporter \
              --restart unless-stopped \
              --net host \
              --pid host \
              -v "/:/host:ro,rslave" \
              quay.io/prometheus/node-exporter:latest \
              --path.rootfs=/host
            
            echo "âœ… GPU Server node-exporter deployed"

      - name: Deploy Monitoring on Main Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # ì„¤ì • í´ë” ìƒì„±
            mkdir -p ~/monitoring
            
            # node-exporter ë°°í¬
            docker stop node-exporter 2>/dev/null || true
            docker rm node-exporter 2>/dev/null || true
            
            docker run -d \
              --name node-exporter \
              --restart unless-stopped \
              --net host \
              --pid host \
              -v "/:/host:ro,rslave" \
              quay.io/prometheus/node-exporter:latest \
              --path.rootfs=/host
            
            # Prometheus ì„¤ì • íŒŒì¼ ìƒì„±
            cat > ~/monitoring/prometheus.yml << 'EOF'
            global:
              scrape_interval: 15s

            scrape_configs:
              - job_name: 'prometheus'
                static_configs:
                  - targets: ['localhost:9090']

              - job_name: 'main-server'
                static_configs:
                  - targets: ['localhost:9100']
                    labels:
                      server: 'main'

              - job_name: 'gpu-server'
                static_configs:
                  - targets: ['10.0.83.48:9100']
                    labels:
                      server: 'gpu'
            EOF
            
            # Prometheus ë°°í¬
            docker stop prometheus 2>/dev/null || true
            docker rm prometheus 2>/dev/null || true
            
            docker run -d \
              --name prometheus \
              --restart unless-stopped \
              --net host \
              -v ~/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro \
              prom/prometheus:latest
            
            # Grafana ë°°í¬
            docker stop grafana 2>/dev/null || true
            docker rm grafana 2>/dev/null || true
            
            docker run -d \
              --name grafana \
              --restart unless-stopped \
              -p 3001:3000 \
              -v grafana-data:/var/lib/grafana \
              -e GF_SERVER_ROOT_URL=https://tcurity.com/grafana/ \
              -e GF_SERVER_SERVE_FROM_SUB_PATH=true \
              grafana/grafana:latest
            
            echo "âœ… Main Server monitoring stack deployed"

  # ============================================================
  # Nginx ë°°í¬ (Main Server) - HTTPS + MLflow + Grafana ì¸ì¦
  # ============================================================
  deploy-nginx:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'nginx'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Nginx with HTTPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # Nginx ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/nginx
            
            # Certbot webroot ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/certbot
            
            # htpasswd íŒŒì¼ ìƒì„± (ì—†ìœ¼ë©´)
            if [ ! -f ~/nginx/.htpasswd ]; then
              # apache2-utils ì„¤ì¹˜ (htpasswd ëª…ë ¹ì–´ìš©)
              if ! command -v htpasswd &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y apache2-utils
              fi
              htpasswd -cb ~/nginx/.htpasswd mlflow '${{ secrets.MLFLOW_PASSWORD }}'
              echo "âœ… htpasswd file created"
            fi
            
            # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
            cat > ~/nginx/default.conf << 'NGINXCONF'
            server {
                listen 80;
                server_name tcurity.com www.tcurity.com;
                
                location /.well-known/acme-challenge/ {
                    root /var/www/certbot;
                }
                
                location / {
                    return 301 https://$host$request_uri;
                }
            }

            server {
                listen 443 ssl;
                http2 on;
                server_name tcurity.com www.tcurity.com;

                ssl_certificate /etc/letsencrypt/live/tcurity.com/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/tcurity.com/privkey.pem;
                
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_prefer_server_ciphers on;
                ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

                # API ê²½ë¡œ (/api/)
                location /api/ {
                    add_header 'Access-Control-Allow-Origin' '*' always;
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                    add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key' always;

                    if ($request_method = 'OPTIONS') {
                        add_header 'Access-Control-Allow-Origin' '*';
                        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key';
                        return 204;
                    }

                    proxy_pass http://172.17.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                # SDKìš© API ê²½ë¡œ (/v1/ -> /api/v1/)
                location /v1/ {
                    add_header 'Access-Control-Allow-Origin' '*' always;
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                    add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key' always;

                    if ($request_method = 'OPTIONS') {
                        add_header 'Access-Control-Allow-Origin' '*';
                        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key';
                        return 204;
                    }

                    rewrite ^/v1/(.*)$ /api/v1/$1 break;
                    proxy_pass http://172.17.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location = /sdk.js {
                    proxy_pass http://172.17.0.1:3000/sdk.js;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    add_header Cache-Control "no-cache, no-store, must-revalidate";
                    add_header Pragma "no-cache";
                    add_header Expires "0";
                }

                location /ticket-site-demo/ {
                    rewrite ^/ticket-site-demo/(.*)$ /$1 break;
                    proxy_pass http://172.17.0.1:5173;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_intercept_errors on;
                    error_page 404 = /index.html;
                }

                # ë©”ì¸: ëžœë”© íŽ˜ì´ì§€
                location / {
                    proxy_pass http://172.17.0.1:4000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location /health {
                    access_log off;
                    return 200 'OK';
                    add_header Content-Type text/plain;
                }

                # MLflow UI (Basic Auth ë³´í˜¸)
                location /mlflow/ {
                    auth_basic "MLflow";
                    auth_basic_user_file /etc/nginx/.htpasswd;
                    
                    proxy_pass http://10.0.83.48:5000/;
                    proxy_set_header Host 10.0.83.48:5000;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }

                # Grafana UI (Basic Auth ë³´í˜¸)
                location /grafana/ {
                    auth_basic "Grafana";
                    auth_basic_user_file /etc/nginx/.htpasswd;
                    
                    proxy_pass http://127.0.0.1:3001/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }
            }
            NGINXCONF
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±°
            docker stop tcurity-nginx 2>/dev/null || true
            docker rm tcurity-nginx 2>/dev/null || true
            
            # Nginx ì‹¤í–‰ (SSL ì¸ì¦ì„œ + htpasswd + certbot ë³¼ë¥¨ ë§ˆìš´íŠ¸)
            docker run -d \
              --name tcurity-nginx \
              --restart unless-stopped \
              --network host \
              -v ~/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro \
              -v ~/nginx/.htpasswd:/etc/nginx/.htpasswd:ro \
              -v /etc/letsencrypt:/etc/letsencrypt:ro \
              -v /var/www/certbot:/var/www/certbot:ro \
              nginx:1.25-alpine
            
            echo "âœ… Nginx deployed with HTTPS + MLflow + Grafana auth"

  # ============================================================
  # ë°°í¬ ê²°ê³¼ ìš”ì•½
  # ============================================================
  summary:
    needs: [setup, deploy-backend, deploy-ai, deploy-sdk, deploy-demo, deploy-landing, deploy-monitoring, deploy-nginx]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI | ${{ needs.deploy-ai.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK | ${{ needs.deploy-sdk.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Demo | ${{ needs.deploy-demo.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | ${{ needs.deploy-landing.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ needs.deploy-monitoring.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginx | ${{ needs.deploy-nginx.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'aws-test' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Main Server:** ${{ needs.setup.outputs.main_host }}" >> $GITHUB_STEP_SUMMARY
          echo "**GPU Server:** ${{ needs.setup.outputs.gpu_host }}" >> $GITHUB_STEP_SUMMARY
name: Deploy Services

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - ai
          - sdk
          - demo
          - landing
          - nginx
          - monitoring
      environment:
        description: 'Target environment'
        required: true
        default: 'kakao-prod'
        type: choice
        options:
          - aws-test
          - kakao-prod
  repository_dispatch:
    types: [deploy-backend, deploy-ai, deploy-sdk, deploy-demo, deploy-landing, deploy-all]

env:
  REGISTRY: ghcr.io
  ORG: t-curity

jobs:
  # ============================================================
  # í™˜ê²½ ì„¤ì •
  # ============================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      main_host: ${{ steps.env.outputs.main_host }}
      gpu_host: ${{ steps.env.outputs.gpu_host }}
      gpu_private: ${{ steps.env.outputs.gpu_private }}
      service: ${{ steps.svc.outputs.service }}
    steps:
      - name: Set environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'kakao-prod' }}"
          if [ "$ENV" = "kakao-prod" ]; then
            echo "main_host=61.109.236.16" >> $GITHUB_OUTPUT
            echo "gpu_host=61.109.238.4" >> $GITHUB_OUTPUT
            echo "gpu_private=10.0.83.48" >> $GITHUB_OUTPUT
          else
            echo "main_host=3.36.60.13" >> $GITHUB_OUTPUT
            echo "gpu_host=54.180.253.215" >> $GITHUB_OUTPUT
            echo "gpu_private=10.0.83.190" >> $GITHUB_OUTPUT
          fi

      - name: Set service
        id: svc
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            case "${{ github.event.action }}" in
              deploy-backend) echo "service=backend" >> $GITHUB_OUTPUT ;;
              deploy-ai) echo "service=ai" >> $GITHUB_OUTPUT ;;
              deploy-sdk) echo "service=sdk" >> $GITHUB_OUTPUT ;;
              deploy-demo) echo "service=demo" >> $GITHUB_OUTPUT ;;
              deploy-landing) echo "service=landing" >> $GITHUB_OUTPUT ;;
              *) echo "service=all" >> $GITHUB_OUTPUT ;;
            esac
          else
            echo "service=${{ github.event.inputs.service || 'all' }}" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # Main Server ë°°í¬ (Docker Compose)
  # ============================================================
  deploy-main:
    needs: setup
    if: |
      needs.setup.outputs.service == 'all' || 
      needs.setup.outputs.service == 'backend' ||
      needs.setup.outputs.service == 'sdk' ||
      needs.setup.outputs.service == 'demo' ||
      needs.setup.outputs.service == 'landing' ||
      needs.setup.outputs.service == 'nginx' ||
      needs.setup.outputs.service == 'monitoring'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy compose files to Main Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker/docker-compose.main.yml,docker/nginx/,docker/monitoring/"
          target: "/home/ubuntu/infra-deploy/"
          strip_components: 0

      - name: Deploy to Main Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /home/ubuntu/infra-deploy/docker
            
            # GHCR ë¡œê·¸ì¸
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ì„œë¹„ìŠ¤ë³„ ë°°í¬
            SERVICE="${{ needs.setup.outputs.service }}"
            
            if [ "$SERVICE" = "all" ]; then
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (compose ì™¸ë¶€ì—ì„œ ì‹¤í–‰ëœ ê²ƒë“¤)
              docker stop tcurity-backend tcurity-sdk tcurity-demo tcurity-landing tcurity-nginx node-exporter prometheus grafana 2>/dev/null || true
              docker rm tcurity-backend tcurity-sdk tcurity-demo tcurity-landing tcurity-nginx node-exporter prometheus grafana 2>/dev/null || true
              
              # ì „ì²´ ë°°í¬
              docker compose -f docker-compose.main.yml down --remove-orphans || true
              docker compose -f docker-compose.main.yml pull
              docker compose -f docker-compose.main.yml up -d
              
            elif [ "$SERVICE" = "monitoring" ]; then
              # ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì»¨í…Œì´ë„ˆ ì •ë¦¬
              docker stop node-exporter prometheus grafana 2>/dev/null || true
              docker rm node-exporter prometheus grafana 2>/dev/null || true
              
              # ëª¨ë‹ˆí„°ë§ë§Œ ë°°í¬
              docker compose -f docker-compose.main.yml pull node-exporter prometheus grafana
              docker compose -f docker-compose.main.yml up -d node-exporter prometheus grafana
              
            else
              # íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì •ë¦¬ ë° ë°°í¬
              docker stop tcurity-$SERVICE 2>/dev/null || true
              docker rm tcurity-$SERVICE 2>/dev/null || true
              
              docker compose -f docker-compose.main.yml pull $SERVICE
              docker compose -f docker-compose.main.yml up -d $SERVICE
            fi
            
            # ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "âœ… Main Server deployed: $SERVICE"

  # ============================================================
  # GPU Server ë°°í¬ (Docker Compose)
  # ============================================================
  deploy-gpu:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'ai'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy compose files to GPU Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ needs.setup.outputs.gpu_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker/docker-compose.gpu.yml"
          target: "/home/ubuntu/infra-deploy/"
          strip_components: 0

      - name: Deploy to GPU Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'kakao-prod' }}
        with:
          host: ${{ needs.setup.outputs.gpu_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DEPLOY_ENV
          script: |
            set -e
            cd /home/ubuntu/infra-deploy/docker
            
            # GHCR ë¡œê·¸ì¸
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop tcurity-ai node-exporter mlflow 2>/dev/null || true
            docker rm tcurity-ai node-exporter mlflow 2>/dev/null || true
            
            # compose down
            docker compose -f docker-compose.gpu.yml down --remove-orphans || true
            
            # AI ì„œë¹„ìŠ¤ ë°°í¬
            docker compose -f docker-compose.gpu.yml pull
            docker compose -f docker-compose.gpu.yml up -d
            
            # ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "âœ… GPU Server deployed"

  # ============================================================
  # ë°°í¬ ê²°ê³¼ ìš”ì•½
  # ============================================================
  summary:
    needs: [setup, deploy-main, deploy-gpu]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Server | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Main Server | ${{ needs.deploy-main.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GPU Server | ${{ needs.deploy-gpu.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ needs.setup.outputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'kakao-prod' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Main Server:** ${{ needs.setup.outputs.main_host }}" >> $GITHUB_STEP_SUMMARY
          echo "**GPU Server:** ${{ needs.setup.outputs.gpu_host }}" >> $GITHUB_STEP_SUMMARY
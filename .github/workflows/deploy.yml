name: Deploy Services

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - ai
          - sdk
          - demo
          - nginx
      environment:
        description: 'Target environment'
        required: true
        default: 'kakao-prod'
        type: choice
        options:
          - aws-test
          - kakao-prod

  repository_dispatch:
    types: [deploy-backend, deploy-ai, deploy-sdk, deploy-demo, deploy-all]

env:
  REGISTRY: ghcr.io
  ORG: t-curity

jobs:
  # ============================================================
  # í™˜ê²½ ì„¤ì •
  # ============================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      main_host: ${{ steps.env.outputs.main_host }}
      gpu_host: ${{ steps.env.outputs.gpu_host }}
      gpu_private: ${{ steps.env.outputs.gpu_private }}
      service: ${{ steps.svc.outputs.service }}
    steps:
      - name: Set environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'kakao-prod' }}"
          
          if [ "$ENV" = "kakao-prod" ]; then
            # ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ í”„ë¡œë•ì…˜
            echo "main_host=61.109.236.16" >> $GITHUB_OUTPUT
            echo "gpu_host=61.109.238.4" >> $GITHUB_OUTPUT
            echo "gpu_private=10.0.83.48" >> $GITHUB_OUTPUT
          else
            # AWS í…ŒìŠ¤íŠ¸ (ê¸°ë³¸ê°’)
            echo "main_host=3.36.60.13" >> $GITHUB_OUTPUT
            echo "gpu_host=54.180.253.215" >> $GITHUB_OUTPUT
            echo "gpu_private=10.0.83.190" >> $GITHUB_OUTPUT
          fi
          
      - name: Set service
        id: svc
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            case "${{ github.event.action }}" in
              deploy-backend) echo "service=backend" >> $GITHUB_OUTPUT ;;
              deploy-ai) echo "service=ai" >> $GITHUB_OUTPUT ;;
              deploy-sdk) echo "service=sdk" >> $GITHUB_OUTPUT ;;
              deploy-demo) echo "service=demo" >> $GITHUB_OUTPUT ;;
              *) echo "service=all" >> $GITHUB_OUTPUT ;;
            esac
          else
            echo "service=${{ github.event.inputs.service || 'all' }}" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # Backend ë°°í¬ (Main Server)
  # ============================================================
  deploy-backend:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'backend'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/backend:develop
            docker stop tcurity-backend 2>/dev/null || true
            docker rm tcurity-backend 2>/dev/null || true
            
            docker run -d \
              --name tcurity-backend \
              --restart unless-stopped \
              -p 8000:8000 \
              -e AI_SERVER_URL=http://${{ needs.setup.outputs.gpu_private }}:9000 \
              -e TCURITY_API_URL=http://localhost:8000 \
              -e CLIENT_SECRET_KEY=demo-secret-key-123 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/backend:develop
            
            docker image prune -f
            echo "âœ… Backend deployed"

  # ============================================================
  # AI Server ë°°í¬ (GPU Server)
  # ============================================================
  deploy-ai:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'ai'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy AI Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'aws-test' }}
        with:
          host: ${{ needs.setup.outputs.gpu_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DEPLOY_ENV
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/ai:develop
            docker stop tcurity-ai 2>/dev/null || true
            docker rm tcurity-ai 2>/dev/null || true
            
            # GPU ì˜µì…˜: ì¹´ì¹´ì˜¤ëŠ” GPU ì‚¬ìš©, AWSëŠ” CPUë§Œ
            if [ "$DEPLOY_ENV" = "kakao-prod" ]; then
              GPU_OPT="--gpus all"
            else
              GPU_OPT=""
            fi
            
            docker run -d \
              --name tcurity-ai \
              --restart unless-stopped \
              $GPU_OPT \
              -p 9000:9000 \
              -v /home/ubuntu/tcurity-ai/models:/models:ro \
              -v /home/ubuntu/tcurity-ai/data:/data:ro \
              -v /home/ubuntu/tcurity-ai/data/drag_trainset:/data/drag_trainset:rw \
              -v /home/ubuntu/tcurity-ai/data/phase_b:/data/phase_b:rw \
              -e MODEL_A_DIR=/models/phase_a \
              -e MODEL_B_DIR=/models/phase_b \
              -e PROJECT_ROOT=/app \
              -e MLFLOW_EXPERIMENT_NAME=captcha-effnet-tracking \
              -e IMAGE_DATA_ROOT=/data/images \
              -e MODEL_OUTPUT_ROOT=/app/models \
              -e PHASE_B_PROBLEM_IMAGE_ROOT=/data/processed_images \
              -e PHASE_A_SAVE_ENABLED=1 \
              -e PHASE_A_SAVE_RATIO=1.0 \
              -e PHASE_A_DATA_DIR=/data/drag_trainset \
              -e PHASE_B_SAVE_ENABLED=1 \
              -e PHASE_B_SAVE_RATIO=1.0 \
              -e PHASE_B_DATA_DIR=/data/phase_b \
              ${{ env.REGISTRY }}/${{ env.ORG }}/ai:develop
            
            docker image prune -f
            echo "âœ… AI Server deployed"

  # ============================================================
  # SDK ë°°í¬ (Main Server)
  # ============================================================
  deploy-sdk:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'sdk'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy SDK
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/sdk:dev
            docker stop tcurity-sdk 2>/dev/null || true
            docker rm tcurity-sdk 2>/dev/null || true
            
            docker run -d \
              --name tcurity-sdk \
              --restart unless-stopped \
              -p 3000:80 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/sdk:dev
            
            docker image prune -f
            echo "âœ… SDK deployed"

  # ============================================================
  # Demo Site ë°°í¬ (Main Server)
  # ============================================================
  deploy-demo:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'demo'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Demo Site
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            docker pull ${{ env.REGISTRY }}/${{ env.ORG }}/demo:dev
            docker stop tcurity-demo 2>/dev/null || true
            docker rm tcurity-demo 2>/dev/null || true
            
            docker run -d \
              --name tcurity-demo \
              --restart unless-stopped \
              -p 5173:80 \
              ${{ env.REGISTRY }}/${{ env.ORG }}/demo:dev
            
            docker image prune -f
            echo "âœ… Demo Site deployed"

  # ============================================================
  # Nginx ë°°í¬ (Main Server) - HTTPS ì ìš©
  # ============================================================
  deploy-nginx:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'nginx'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Nginx with HTTPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # Nginx ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/nginx
            
            # Nginx ì„¤ì • íŒŒì¼ ìƒì„± (HTTPS + CORS + /v1/ ê²½ë¡œ í¬í•¨)
            cat > ~/nginx/default.conf << 'NGINXCONF'
            server {
                listen 80;
                server_name tcurity.com www.tcurity.com;
                
                location /.well-known/acme-challenge/ {
                    root /var/www/certbot;
                }
                
                location / {
                    return 301 https://$host$request_uri;
                }
            }

            server {
                listen 443 ssl;
                http2 on;
                server_name tcurity.com www.tcurity.com;

                ssl_certificate /etc/letsencrypt/live/tcurity.com/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/tcurity.com/privkey.pem;
                
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_prefer_server_ciphers on;
                ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

                # API ê²½ë¡œ (/api/)
                location /api/ {
                    add_header 'Access-Control-Allow-Origin' '*' always;
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                    add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key' always;

                    if ($request_method = 'OPTIONS') {
                        add_header 'Access-Control-Allow-Origin' '*';
                        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key';
                        return 204;
                    }

                    proxy_pass http://172.17.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                # SDKìš© API ê²½ë¡œ (/v1/)
                location /v1/ {
                    add_header 'Access-Control-Allow-Origin' '*' always;
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                    add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key' always;

                    if ($request_method = 'OPTIONS') {
                        add_header 'Access-Control-Allow-Origin' '*';
                        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                        add_header 'Access-Control-Allow-Headers' 'Content-Type, X-Client-Id, X-Session-Id, X-Client-Secret-Key';
                        return 204;
                    }

                    proxy_pass http://172.17.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location = /sdk.js {
                    proxy_pass http://172.17.0.1:3000/sdk.js;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location /ticket-site-demo/ {
                    rewrite ^/ticket-site-demo/(.*)$ /$1 break;
                    proxy_pass http://172.17.0.1:5173;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_intercept_errors on;
                    error_page 404 = /index.html;
                }

                location / {
                    proxy_pass http://172.17.0.1:5173;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location /health {
                    access_log off;
                    return 200 'OK';
                    add_header Content-Type text/plain;
                }
            }
            NGINXCONF
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì œê±°
            docker stop tcurity-nginx 2>/dev/null || true
            docker rm tcurity-nginx 2>/dev/null || true
            
            # Nginx ì‹¤í–‰ (SSL ì¸ì¦ì„œ ë³¼ë¥¨ ë§ˆìš´íŠ¸)
            docker run -d \
              --name tcurity-nginx \
              --restart unless-stopped \
              --network host \
              -v ~/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro \
              -v /etc/letsencrypt:/etc/letsencrypt:ro \
              nginx:1.25-alpine
            
            echo "âœ… Nginx deployed with HTTPS"

  # ============================================================
  # ë°°í¬ ê²°ê³¼ ìš”ì•½
  # ============================================================
  summary:
    needs: [setup, deploy-backend, deploy-ai, deploy-sdk, deploy-demo, deploy-nginx]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI | ${{ needs.deploy-ai.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK | ${{ needs.deploy-sdk.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Demo | ${{ needs.deploy-demo.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginx | ${{ needs.deploy-nginx.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'aws-test' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Main Server:** ${{ needs.setup.outputs.main_host }}" >> $GITHUB_STEP_SUMMARY
          echo "**GPU Server:** ${{ needs.setup.outputs.gpu_host }}" >> $GITHUB_STEP_SUMMARY
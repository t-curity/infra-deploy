deploy-nginx:
    needs: setup
    if: needs.setup.outputs.service == 'all' || needs.setup.outputs.service == 'nginx'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.setup.outputs.main_host }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # Nginx 설정 디렉토리 생성
            mkdir -p ~/nginx
            
            # Nginx 설정 파일 생성 (HTTPS 포함)
            cat > ~/nginx/default.conf << 'NGINXCONF'
            server {
                listen 80;
                server_name tcurity.com www.tcurity.com;
                
                # Let's Encrypt 인증용
                location /.well-known/acme-challenge/ {
                    root /var/www/certbot;
                }
                
                # HTTP를 HTTPS로 리다이렉트
                location / {
                    return 301 https://$host$request_uri;
                }
            }

            server {
                listen 443 ssl http2;
                server_name tcurity.com www.tcurity.com;

                # SSL 인증서
                ssl_certificate /etc/letsencrypt/live/tcurity.com/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/tcurity.com/privkey.pem;
                
                # SSL 설정
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_prefer_server_ciphers on;
                ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

                location /api/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location = /sdk.js {
                    proxy_pass http://127.0.0.1:3000/sdk.js;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location /ticket-site-demo/ {
                    rewrite ^/ticket-site-demo/(.*)$ /$1 break;
                    proxy_pass http://127.0.0.1:5173;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_intercept_errors on;
                    error_page 404 = /index.html;
                }

                location / {
                    proxy_pass http://127.0.0.1:5173;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location /health {
                    access_log off;
                    return 200 'OK';
                    add_header Content-Type text/plain;
                }
            }
            NGINXCONF
            
            # 기존 컨테이너 제거
            docker stop tcurity-nginx 2>/dev/null || true
            docker rm tcurity-nginx 2>/dev/null || true
            
            # Nginx 실행 (SSL 인증서 볼륨 마운트)
            docker run -d \
              --name tcurity-nginx \
              --restart unless-stopped \
              --network host \
              -v ~/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro \
              -v /etc/letsencrypt:/etc/letsencrypt:ro \
              nginx:1.25-alpine
            
            echo "✅ Nginx deployed with HTTPS"